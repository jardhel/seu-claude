name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run security scan weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  security-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Run npm audit (JSON output)
        run: npm audit --json > audit-results.json || true

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: audit-results.json
          retention-days: 30

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: +security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: '/language:javascript-typescript'

  secrets-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check licenses
        run: |
          npx license-checker --summary --failOn "GPL;AGPL;LGPL;CDDL;CPAL"
        continue-on-error: true

  token-rotation-reminder:
    name: Token Rotation Reminder
    runs-on: ubuntu-latest
    # Only run on schedule (weekly)
    if: github.event_name == 'schedule'

    steps:
      - name: Check token age reminder
        run: |
          echo "üîê Security Reminder: Review your NPM_TOKEN"
          echo ""
          echo "Best practices for token security:"
          echo "1. Use granular access tokens with expiration dates"
          echo "2. Rotate tokens every 90 days"
          echo "3. Use IP allowlists for GitHub Actions"
          echo "4. Review access token usage at npmjs.com"
          echo ""
          echo "To rotate your NPM token:"
          echo "1. Go to npmjs.com ‚Üí Access Tokens"
          echo "2. Generate new Granular Access Token"
          echo "3. Update GitHub secret: NPM_TOKEN"
          echo "4. Delete old token"

      - name: Create rotation issue (optional)
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date();
            const issueTitle = `üîê Security: Review NPM Token (${today.toISOString().split('T')[0]})`;

            // Check if issue already exists this month
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,token-rotation'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: `## üîê Monthly Security Reminder\n\nPlease review and consider rotating your NPM access token.\n\n### Checklist\n- [ ] Review token permissions at npmjs.com\n- [ ] Check token expiration date\n- [ ] Rotate if older than 90 days\n- [ ] Update GitHub secret if rotated\n\n### Resources\n- [NPM Access Tokens](https://www.npmjs.com/settings/tokens)\n- [GitHub Secrets](https://github.com/${context.repo.owner}/${context.repo.repo}/settings/secrets/actions)`,
                labels: ['security', 'token-rotation']
              });
            }
        continue-on-error: true
