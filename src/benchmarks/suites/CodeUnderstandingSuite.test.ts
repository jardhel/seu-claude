/**
 * Tests for CodeUnderstandingSuite
 */

import { describe, it, expect, beforeEach } from 'vitest';
import { CodeUnderstandingSuite } from './CodeUnderstandingSuite.js';

describe('CodeUnderstandingSuite', () => {
  let suite: CodeUnderstandingSuite;

  beforeEach(() => {
    suite = new CodeUnderstandingSuite();
  });

  describe('properties', () => {
    it('should have correct name', () => {
      expect(suite.name).toBe('code-understanding');
    });

    it('should have correct description', () => {
      expect(suite.description).toContain('symbol resolution');
      expect(suite.description).toContain('RecursiveScout');
    });

    it('should support expected languages', () => {
      expect(suite.supportedLanguages).toContain('typescript');
      expect(suite.supportedLanguages).toContain('javascript');
      expect(suite.supportedLanguages).toContain('python');
    });
  });

  describe('loadTestCases', () => {
    it('should generate test cases from source directory', async () => {
      // Use the seu-claude src directory as a test dataset
      const testCases = await suite.loadTestCases(process.cwd());

      // Should generate some test cases from existing source
      expect(testCases.length).toBeGreaterThanOrEqual(0);
    });

    it('should tag auto-generated test cases', async () => {
      const testCases = await suite.loadTestCases(process.cwd());

      // If there are auto-generated cases, they should have proper tags
      const autoGenerated = testCases.filter(tc => tc.tags?.includes('auto-generated'));

      for (const tc of autoGenerated) {
        expect(tc.tags).toBeDefined();
        expect(tc.id).toMatch(/^(symbol|callgraph):/);
      }
    });
  });

  describe('runTestCase', () => {
    it('should handle symbol lookup test case', async () => {
      const testCase = {
        id: 'symbol:test_1',
        description: 'Find TaskManager class',
        input: {
          symbolName: 'TaskManager',
          entryPoints: [`${process.cwd()}/src/core/usecases/TaskManager.ts`],
        },
        expected: {
          definitions: [
            { file: 'TaskManager.ts', line: 28, type: 'class' },
          ],
          callSites: [],
        },
      };

      const result = await suite.runTestCase(testCase);

      // Should complete without error
      expect(result.testCaseId).toBe('symbol:test_1');
      expect(result.executionTimeMs).toBeGreaterThan(0);
      expect(result.metrics.length).toBeGreaterThan(0);

      // Should have actual results
      expect(result.actual).toBeDefined();
    });

    it('should handle call graph test case', async () => {
      const testCase = {
        id: 'callgraph:test_1',
        description: 'Call graph for createRootGoal',
        input: {
          targetSymbol: 'createRootGoal',
          entryPoints: [`${process.cwd()}/src/core/usecases/TaskManager.ts`],
        },
        expected: {
          callers: [],
          callees: [],
        },
      };

      const result = await suite.runTestCase(testCase);

      expect(result.testCaseId).toBe('callgraph:test_1');
      expect(result.executionTimeMs).toBeGreaterThan(0);
      expect(result.actual).toBeDefined();
    });

    it('should return error for invalid test case type', async () => {
      const testCase = {
        id: 'unknown:test_1',
        description: 'Unknown test type',
        input: {},
        expected: {},
      };

      const result = await suite.runTestCase(testCase);

      expect(result.passed).toBe(false);
      expect(result.error).toContain('Unknown test case type');
    });

    it('should include memory usage in results', async () => {
      const testCase = {
        id: 'symbol:memory_test',
        description: 'Test memory tracking',
        input: {
          symbolName: 'RecursiveScout',
          entryPoints: [`${process.cwd()}/src/core/usecases/RecursiveScout.ts`],
        },
        expected: {
          definitions: [],
          callSites: [],
        },
      };

      const result = await suite.runTestCase(testCase);

      expect(result.memoryUsedBytes).toBeDefined();
    });
  });

  describe('run', () => {
    it('should run complete suite and return results', async () => {
      const config = {
        name: 'test-run',
        description: 'Test suite run',
        measurementIterations: 1,
        timeoutMs: 30000,
      };

      // Run on minimal dataset
      const result = await suite.run(config, process.cwd());

      expect(result.config.name).toBe('code-understanding');
      expect(result.timestamp).toBeDefined();
      expect(result.systemVersion).toBe('seu-claude-v2');
      // Execution time can be 0 if no test cases are loaded (no dataset files)
      expect(result.totalExecutionTimeMs).toBeGreaterThanOrEqual(0);

      // Should have latency stats
      expect(result.latencyStats).toBeDefined();
      expect(result.latencyStats.mean).toBeGreaterThanOrEqual(0);

      // Aggregated metrics should exist (may be empty if no test cases)
      expect(result.aggregatedMetrics).toBeDefined();
      expect(Array.isArray(result.aggregatedMetrics)).toBe(true);
    }, 60000); // Longer timeout for full suite
  });
});
